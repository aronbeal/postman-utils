!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.PostmanUtilsFactory=t():e.PostmanUtilsFactory=t()}(this,(()=>(()=>{"use strict";var e={116:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0});const s=r(500),o=r(530);t.default=class{constructor(e,t){this.pm=e,this.logger=t}assertPostmanVariable(e){if(!this.pm.variables.has(e))throw new Error(`The environment variable ${e} should exist as a local variable, but does not.  It may have been cleared by a prior operation, or not yet set with the appropriate LIST or POST call.`);return this}hasState(e){return this.pm.collectionVariables.has(e)}loadState(e){if(!this.hasState(e))throw new Error(`Attempted to load a non-existent storage key: ${e}`);let t=this.getCollectionVariable(e);if(void 0===t)return t;let r=typeof t;if("string"!==r)throw new Error(`Expected a string (serialized object) for environment variable key ${e}, but got ${r}`);try{let e=JSON.parse(t);if("object"!=typeof e)throw new Error;return e}catch(t){throw new Error(`Could not decode ${e}, into a state object.`)}}saveState(e,t){if("object"!=typeof t)throw new Error(`Current state ${t} not recognizable as a state object.`);let r=JSON.stringify(t);if("string"!=typeof r)throw new Error(`Expected a string (serialized object) for variable ${t}, but got ${typeof t}`);return this.setCollectionVariable(e,r),this}clearCollectionVariables(){return this.pm.collectionVariables.clear(),this}getCollectionVariable(e){let t=this.pm.collectionVariables.get(e);return(0,s.is_empty)(t)?void 0:t}setCollectionVariable(e,t){return this.logger.log("Environment: setting "+e+" to "+t,o.LogLevel.info,o.LogVerbosity.minimal),this.pm.collectionVariables.set(e,t),this.logger.log(["Collection variables in utils",this.pm.collectionVariables.toObject()],o.LogLevel.info,o.LogVerbosity.very_verbose),this}unsetCollectionVariable(e){return this.logger.log("Clearing "+e+" in pm.collectionVariables",o.LogLevel.info,o.LogVerbosity.very_verbose),Object.keys(this.pm.collectionVariables.toObject()).filter((t=>e===t)).map((e=>this.pm.collectionVariables.unset(e))),this}}},500:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.random_string=t.is_empty=t.iri_to_id=void 0,t.iri_to_id=e=>"string"!=typeof e?e:e.replace(/.*\/([^\/]+)$/,"$1").toString(),t.is_empty=e=>null==e||""===e,t.random_string=(e,t)=>{let r="";t.indexOf("a")>-1&&(r+="abcdefghijklmnopqrstuvwxyz"),t.indexOf("A")>-1&&(r+="ABCDEFGHIJKLMNOPQRSTUVWXYZ"),t.indexOf("#")>-1&&(r+="0123456789"),t.indexOf("!")>-1&&(r+="~`!@#$%^&*()_+-={}[]:\";'<>?,./|\\");let s="";for(let t=e;t>0;--t)s+=r[Math.floor(Math.random()*r.length)];return s}},530:(e,t)=>{var r,s;Object.defineProperty(t,"__esModule",{value:!0}),t.LogVerbosity=t.LogLevel=void 0,function(e){e.default="default",e.info="info",e.warn="warn",e.error="error",e.trace="trace"}(r||(r={})),t.LogLevel=r,function(e){e[e.none=0]="none",e[e.minimal=1]="minimal",e[e.verbose=2]="verbose",e[e.very_verbose=3]="very_verbose",e[e.default=1]="default"}(s||(s={})),t.LogVerbosity=s,t.default=class{constructor(e=1){this.msgs=[],this.verbosityPreference=e}setVerbosity(e){return console.info(`Logger verbosity set to ${s[e]}`),this.verbosityPreference=e,this}dump(e,t=r.default,o=s.default){this.log([e],t,o)}log(e,t=r.default,o=s.default){this.verbosityPreference<o||("string"==typeof e&&(e=[e]),e.map((e=>{switch(t){case r.info:console.info(e);break;case r.warn:console.warn(e);break;case r.error:console.error(e);break;case r.trace:console.trace(e);break;case r.default:default:console.log(e)}})))}}},56:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=class{constructor(e){this.raw=e;const t=JSON.parse(e);this.object=t}getResponseRaw(){return this.raw}getResponseObject(){return this.object}getFromResponse(e){if("string"!=typeof e||""===e)throw new Error("Key passed to getVar() was empty or not a string!");let t=this.getResponseObject(),r=e.split("."),s=[];do{let o=r.shift();if("string"!=typeof o)throw new Error("Unexpected value in keypath in getVar()");if(s.push(o),void 0===t[o]){let t=s.join(".");throw new Error(`The response key ${e} was not found in the response (failed at ${t})`)}t=t[o]}while(r.length>0);return t}isListResponse(){return void 0!==this.getResponseObject()["hydra:member"]&&Array.isArray(this.getResponseObject()["hydra:member"])}getObjects(){let e=null;return this.isListResponse()?e=e["hydra:member"]:Array.isArray(e)||(e=[e]),e}}},107:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.validate_state=void 0;const s=r(530);t.validate_state=e=>e,t.default=class{constructor(e,t,r){this.storage_key=e,this.logger=r,this.env=t,this.current_state=[],this.load()}delete(e){for(let t=0,r=this.current_state[t];t<this.current_state.length;t++,r=this.current_state[t]){if(r.key===e){this.current_state=this.current_state.slice(0,t).concat(this.current_state.slice(t+1)),this.save();break}if(r.key>e)break}return this}load(){if(this.current_state=[],!this.env.hasState(this.storage_key))return this;const e=this.env.loadState(this.storage_key);return this.setAll(e),this}get(e){for(let t=0,r=this.current_state[t];t<this.current_state.length;t++,r=this.current_state[t]){if(r.key===e)return r.value;if(r.key>e)break}throw new Error(`The key ${e} was never set within the state.`)}getAll(){return this.current_state.reduce(((e,t)=>(e[t.key]=t.value,e)),{})}isset(e){try{return this.get(e),!0}catch(e){return!1}}reset(){return this.logger.log("Clearing state...",s.LogLevel.info,s.LogVerbosity.very_verbose),this.current_state=[],this.save(),this}save(){this.env.saveState(this.storage_key,this.getAll()),this.logger.log(`Saved state: ${this.current_state}`,s.LogLevel.default,s.LogVerbosity.very_verbose)}setAll(e){return Object.keys(e).map((t=>this.set(t,e[t]))),this.save(),this}set(e,t){this.logger.log(`Setting ${e} to be ${t}`,s.LogLevel.default,s.LogVerbosity.very_verbose);const r={key:e,value:t};for(let t=0;t<this.current_state.length;t++)if(this.current_state[t].key>e)return this.current_state.splice(t,0,r),this.save(),this;return this.current_state.push(r),this.save(),this}}},474:function(e,t,r){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=s(r(56));t.default=class{constructor(e){this.response=new o.default(e)}getDecodedToken(){let e=this.getToken().split(".")[1];if(!e)throw new Error("Could not extract the Base 64 url out of the token");let t=e.replace(/-/g,"+").replace(/_/g,"/"),r=decodeURIComponent(atob(t).split("").map((function(e){return"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)})).join("")),s=JSON.parse(r);if("object"!=typeof s)throw new Error("Error: Could not construct a decoded token out of the token value "+this.getToken());return s}getToken(){let e=this.response.getResponseObject();if("string"!=typeof e.token)throw new Error("Could not retrieve token!");return e.token}getRefreshToken(){let e=this.response.getResponseObject();if("string"!=typeof e.refresh_token)throw new Error("Could not retrieve refresh token!");return e.refresh_token}}},675:function(e,t,r){var s=this&&this.__createBinding||(Object.create?function(e,t,r,s){void 0===s&&(s=r);var o=Object.getOwnPropertyDescriptor(t,r);o&&!("get"in o?!t.__esModule:o.writable||o.configurable)||(o={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,s,o)}:function(e,t,r,s){void 0===s&&(s=r),e[s]=t[r]}),o=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&s(t,e,r);return o(t,e),t},n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.NamedStates=void 0;const a=n(r(116)),l=n(r(474)),h=i(r(530)),u=r(500),c=n(r(56)),g=n(r(107));t.NamedStates={DEFAULT_STATE:"default-state",STATE:"state"},t.default=class{constructor(e){this.pm=e,this.logger=new h.default,this.env=new a.default(e,this.logger),this.dynamic_state=new g.default(t.NamedStates.STATE,this.env,this.logger),this.default_state=new g.default(t.NamedStates.DEFAULT_STATE,this.env,this.logger)}addTokenData(){let e=new l.default(this.pm.response.text());this.logger.log(["Adding token data:",e.getDecodedToken()],h.LogLevel.info,h.LogVerbosity.minimal);const t=this.getState();t.set("tokens.current",e.getToken()),t.set("refresh_tokens.current",e.getRefreshToken());const r=e.getDecodedToken().email;t.set("tokens."+r,e.getToken()),t.set("refresh_tokens."+r,e.getRefreshToken());const s=e.getDecodedToken();return Object.keys(s).map((e=>{let o=s[e];if(Array.isArray(o))o.map(((s,o)=>{if(!s)throw"No IRI available, cannot get ID.";let i=(0,u.iri_to_id)(s);t.set(r+"."+e+"."+o,i),t.set("current_user."+e+"."+o,i)}));else if("string"==typeof o){let r=(0,u.iri_to_id)(o);t.set("current_user."+e,r)}else t.set("current_user."+e,o)})),this.logger.log("Token data added. ",h.LogLevel.default,h.LogVerbosity.minimal),this}assert(e){return this.env.assertPostmanVariable(e),this}clearEndpointVar(e){this.pm.expect(this.pm.response.code).to.be.oneOf([200,201,204]);const t=this.pm.request.url.path[0],r=this.getState();return r.getAll().filter((r=>r===`${t}.${e}`)).map((e=>r.delete(e))),this}clearEndpointVars(){void 0!==this.pm.response&&this.pm.expect(this.pm.response.code).to.be.oneOf([200,201,204]);const e=this.pm.request.url.path[0],t=this.getState();return t.getAll().filter((t=>t.startsWith(e))).map((e=>t.delete(e))),this}get(e){return this.getState().get(e)}getDefaultState(){return this.default_state}getState(){return this.dynamic_state}getLogger(){return this.logger}getResponse(){return new c.default(this.pm.response.text())}isset(e){return this.getState().isset(e)}prerequest(){this.logger.log("Running universal pre-request",h.LogLevel.info,h.LogVerbosity.verbose)}setDefaultState(e){return e.version="v2.0.0",this.env.clearCollectionVariables(),this.getState().reset().setAll(e),void 0!==e.verbosity&&this.getLogger().setVerbosity(e.verbosity),this}setEndpointVar(e){const t=this.getResponse().getFromResponse("@id"),r=(0,u.iri_to_id)(t),s=this.pm.request.url.path[0];return this.set(`${s}.${e}`,r),this}setEndpointVars(e=null){this.pm.expect(this.pm.response.code).to.be.oneOf([200,201]);let t=this.getResponse().getObjects();if(0===t.length)return this.logger.log("No results returned, not setting any endpoint vars",h.LogLevel.default,h.LogVerbosity.very_verbose),this;const r=e??this.pm.request.url.path[0],s=(e,t,r)=>{this.pm.expect(e).to.be.a("string"),this.pm.expect(t).to.not.be.undefined(),this.pm.expect(r).to.be.an("object"),this.pm.expect(r["@id"]).to.be.a("string");let s=r["@id"];if("string"!=typeof s)throw new Error("IRI could not be found for item in list.");let o=(0,u.iri_to_id)(s);this.set(e+"."+t,o),this.set(e+".iri."+t,s),this.set(e+".objects."+t,r)};return t.map(((e,o)=>{s(r,(o+1).toString(),e),0===o?s(r,"first",e):o===t.length-1&&s(r,"last",e)})),this}set(e,t){return this.getState().set(e,t),this}setFromKey(e,t){return this.set(e,this.getResponse().getFromResponse(t)),this}setFromCallback(e,t){let r=t(this.getResponse().getResponseObject());if((0,u.is_empty)(r))throw new Error("setVarFromCallback: The supplied callback {fn} did not return a value.");return this.set(e,r),this}setRandomString(){return this.set("random_string",(0,u.random_string)(15,"aA")),this}}},607:function(e,t,r){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=s(r(675));t.default=function(e){if("object"!=typeof e)throw new Error("Expected postman object as initial value, got "+typeof e);return new o.default(e)}}},t={};return function r(s){var o=t[s];if(void 0!==o)return o.exports;var i=t[s]={exports:{}};return e[s].call(i.exports,i,i.exports,r),i.exports}(607)})()));
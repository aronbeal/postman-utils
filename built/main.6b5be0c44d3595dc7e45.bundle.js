!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.PostmanUtilsFactory=t():e.PostmanUtilsFactory=t()}(this,(()=>(()=>{"use strict";var e={45:(e,t,o)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.validate_collection_state=t.CollectionStateKeys=void 0;const s=o(116),r=o(530);t.CollectionStateKeys={BASE_URL:"baseUrl",ENVIRONMENT:"environment",FLAG_ENABLE_BLACKFIRE:"enableBlackfire",VERBOSITY:"verbosity",ADMIN_PASSWORD:"adminPassword",SUPER_ADMIN_PASSWORD:"superAdminPassword",DEFAULT_CONTENT_TYPE:"defaultContentType",DEFAULT_LANGUAGE:"defaultLanguage",DEFAULT_PASSWORD:"defaultPassword"};const n=e=>Object.values(t.CollectionStateKeys).includes(e),i={[t.CollectionStateKeys.ADMIN_PASSWORD]:"#Ch@ng3M3!#",[t.CollectionStateKeys.BASE_URL]:null,[t.CollectionStateKeys.DEFAULT_CONTENT_TYPE]:"application/ld+json",[t.CollectionStateKeys.DEFAULT_LANGUAGE]:"en",[t.CollectionStateKeys.DEFAULT_PASSWORD]:"#Ch@ng3M3!#",[t.CollectionStateKeys.ENVIRONMENT]:null,[t.CollectionStateKeys.FLAG_ENABLE_BLACKFIRE]:!1,[t.CollectionStateKeys.SUPER_ADMIN_PASSWORD]:"#Ch@ng3M3!#",[t.CollectionStateKeys.VERBOSITY]:1},l={[t.CollectionStateKeys.ADMIN_PASSWORD]:e=>"string"==typeof e,[t.CollectionStateKeys.BASE_URL]:e=>"string"==typeof e,[t.CollectionStateKeys.DEFAULT_CONTENT_TYPE]:e=>"string"==typeof e,[t.CollectionStateKeys.DEFAULT_LANGUAGE]:e=>"string"==typeof e,[t.CollectionStateKeys.DEFAULT_PASSWORD]:e=>"string"==typeof e,[t.CollectionStateKeys.ENVIRONMENT]:e=>["development","staging","production"].some(e),[t.CollectionStateKeys.FLAG_ENABLE_BLACKFIRE]:e=>void 0===e||"boolean"==typeof e,[t.CollectionStateKeys.SUPER_ADMIN_PASSWORD]:e=>"string"==typeof e,[t.CollectionStateKeys.VERBOSITY]:e=>void 0===e||"number"==typeof e};t.validate_collection_state=e=>{for(let t of Object.keys(e)){if(!n(t))throw new Error(`${t} is not a known collection state key.`);if(null===e[t])throw new Error(`The collection state ${t} was never set.`);if(!(0,l[t])(e[t]))throw new Error(`The value passed for the collection state key ${t} did not match the expected type.`)}return e},t.default=class{constructor(e,t){this.logger=t,this.env=e}validate(){let e=this.env.getObject(s.EnvKeys.COLLECTION_STATE);return(0,t.validate_collection_state)(e),this}apply(e){return e=(0,t.validate_collection_state)(e),this.reset(),Object.keys(e).map((t=>this.set(t,e[t]))),this}getAll(){return this.env.getObject(s.EnvKeys.COLLECTION_STATE)}reset(){return this.logger.log("Clearing environment collection state...",r.LogLevel.info,r.LogVerbosity.verbose),this.env.setObject(s.EnvKeys.COLLECTION_STATE,i),this}set(e,o){let r=this.env.getObject(s.EnvKeys.COLLECTION_STATE);if(void 0===r)throw new Error("Prefs was undefined!  This should not have happened, check CollectionState.ts in postman-utils");return r[e]=o,this.env.setObject(s.EnvKeys.COLLECTION_STATE,r),e===t.CollectionStateKeys.VERBOSITY&&this.logger.setVerbosity(o),this}get(e){if(!n(e))throw new Error(`${e} is not a known preference key.`);let t=this.env.getObject(s.EnvKeys.COLLECTION_STATE);if(void 0===t[e])throw new Error(`The key ${e} was never set within the environment preferences.`);return t[e]}}},116:function(e,t,o){var s=this&&this.__createBinding||(Object.create?function(e,t,o,s){void 0===s&&(s=o);var r=Object.getOwnPropertyDescriptor(t,o);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[o]}}),Object.defineProperty(e,s,r)}:function(e,t,o,s){void 0===s&&(s=o),e[s]=t[o]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var o in e)"default"!==o&&Object.prototype.hasOwnProperty.call(e,o)&&s(t,e,o);return r(t,e),t},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.EnvKeys=void 0;const l=o(500),a=o(530),c=i(o(107)),h=n(o(45));t.EnvKeys={COLLECTION_STATE:"collection-state",STATE:"state",VERSION:"version"},t.default=class{constructor(e,t){this.pm=e,this.logger=t,this.state=new c.default(this,t),this.collection_state=new h.default(this,t)}setPm(e){this.pm=e}reset(e){return t.EnvKeys.COLLECTION_STATE,this.collection_state,t.EnvKeys.STATE,this.state,this.pm.collectionVariables.clear(),this.collection_state.apply(e),this.state.reset(),this.set(t.EnvKeys.VERSION,"v2.0.0"),this.validate(),this.logger=new a.Logger(this.collection_state.get(h.CollectionStateKeys.VERBOSITY)),this.logger.log("Environment reset.",a.LogLevel.info,a.LogVerbosity.verbose),this.logger.dump(this.filter(),a.LogLevel.info,a.LogVerbosity.verbose),this}get(e){let t=this.pm.collectionVariables.get(e);return(0,l.is_empty)(t)?void 0:t}getObject(e){let t=this.get(e);if(void 0===t)return t;let o=typeof t;if("object"===o&&Object(t)===t)return t;if("string"!==o)throw new Error(`Expected a string (serialized object) for environment variable key ${e}, but got ${o}`);let s=JSON.parse(t);if("object"!=typeof s)throw new Error(`Could not decode ${e}, into an object.`);return s}setObject(e,t){if("object"!=typeof t||Object(t)!==t)throw new Error(`Value ${t} not recognizable as an object.`);let o=JSON.stringify(t);if("string"!=typeof o)throw new Error(`Expected a string (serialized object) for variable ${e}, but got ${typeof t}`);return this.set(e,o),this}filter(){return{[t.EnvKeys.COLLECTION_STATE]:this.getObject(t.EnvKeys.COLLECTION_STATE),[t.EnvKeys.STATE]:this.getObject(t.EnvKeys.STATE),[t.EnvKeys.VERSION]:this.get(t.EnvKeys.VERSION)}}set(e,t){return this.logger.log("Environment: setting "+e+" to "+t,a.LogLevel.info,a.LogVerbosity.minimal),this.pm.collectionVariables.set(e,t),this}unset(e){return this.logger.log("Clearing "+e+" in pm.collectionVariables",a.LogLevel.info,a.LogVerbosity.very_verbose),this.pm.collectionVariables.toObject().keys().filter((t=>e===t)).map((e=>this.pm.collectionVariables.unset(e))),this}getState(){return this.state}getCollectionState(){return this.collection_state}validate(){for(const[e,o]of Object.entries(t.EnvKeys))if(!this.pm.collectionVariables.has(o))throw new Error(`The required key ${o} is not present in postman.`);return this.collection_state.validate(),this.state.validate(),this}}},500:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.random_string=t.is_empty=t.iri_to_id=void 0,t.iri_to_id=e=>"string"!=typeof e?e:e.replace(/.*\/([^\/]+)$/,"$1").toString(),t.is_empty=e=>null==e||""===e,t.random_string=(e,t)=>{let o="";t.indexOf("a")>-1&&(o+="abcdefghijklmnopqrstuvwxyz"),t.indexOf("A")>-1&&(o+="ABCDEFGHIJKLMNOPQRSTUVWXYZ"),t.indexOf("#")>-1&&(o+="0123456789"),t.indexOf("!")>-1&&(o+="~`!@#$%^&*()_+-={}[]:\";'<>?,./|\\");let s="";for(let t=e;t>0;--t)s+=o[Math.floor(Math.random()*o.length)];return s}},530:(e,t)=>{var o,s;Object.defineProperty(t,"__esModule",{value:!0}),t.LogVerbosity=t.LogLevel=t.Logger=void 0,function(e){e.default="default",e.info="info",e.warn="warn",e.error="error",e.trace="trace"}(o||(o={})),t.LogLevel=o,function(e){e[e.none=0]="none",e[e.minimal=1]="minimal",e[e.verbose=2]="verbose",e[e.very_verbose=3]="very_verbose",e[e.default=1]="default"}(s||(s={})),t.LogVerbosity=s,t.Logger=class{constructor(e=1){this.msgs=[],this.verbosityPreference=e}setVerbosity(e){return this.verbosityPreference=e,this}dump(e,t=o.default,r=s.default){this.log([e],t,r)}log(e,t=o.default,r=s.default){this.verbosityPreference<r||("string"==typeof e&&(e=[e]),e.map((e=>{switch(t){case o.info:console.info(e);break;case o.warn:console.warn(e);break;case o.error:console.error(e);break;case o.trace:console.trace(e);break;case o.default:default:console.log(e)}})))}}},56:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=class{constructor(e){this.raw=e;const t=JSON.parse(e);this.object=t}getResponseRaw(){return this.raw}getResponseObject(){return this.object}getFromResponse(e){if("string"!=typeof e||""===e)throw new Error("Key passed to getVar() was empty or not a string!");let t=this.getResponseObject(),o=e.split("."),s=[];do{let r=o.shift();if("string"!=typeof r)throw new Error("Unexpected value in keypath in getVar()");if(s.push(r),void 0===t[r]){let t=s.join(".");throw new Error(`The response key ${e} was not found in the response (failed at ${t})`)}t=t[r]}while(o.length>0);return t}isListResponse(){return void 0!==this.getResponseObject()["hydra:member"]&&Array.isArray(this.getResponseObject()["hydra:member"])}getObjects(){let e=null;return this.isListResponse()?e=e["hydra:member"]:Array.isArray(e)||(e=[e]),e}}},107:(e,t,o)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.validate_state=void 0;const s=o(116),r=o(530);t.validate_state=e=>e;class n{constructor(e,t){this.logger=t,this.env=e}static from(e,t){return e.getObject(s.EnvKeys.STATE),new n(e,t)}validate(){let e=this.env.getObject(s.EnvKeys.STATE);return(0,t.validate_state)(e),this}apply(){throw new Error("Not yet implemented")}reset(){this.logger.log("Clearing state...",r.LogLevel.info,r.LogVerbosity.very_verbose),this.env.setObject(s.EnvKeys.STATE,{initialized:(new Date).toLocaleString("en-CA")})}get(e){let t=this.getAll();if(void 0===t[e])throw new Error(`The key ${e} was never set within the environment state.`);return t[e]}getAll(){return this.env.getObject(s.EnvKeys.STATE)??{}}isset(e){return void 0!==typeof this.getAll()[e]}setAll(e){return this.env.setObject(s.EnvKeys.STATE,e??{}),this}set(e,t){let o=this.getAll();return this.logger.log(`Setting ${e} to be ${t}`,r.LogLevel.default,r.LogVerbosity.very_verbose),o[e]=t,this.env.setObject(s.EnvKeys.STATE,o),this.logger.log(`New state: ${this.getAll()}`,r.LogLevel.default,r.LogVerbosity.very_verbose),this}delete(e){let t=this.env.getObject(s.EnvKeys.STATE);return delete t[e],this.env.setObject(s.EnvKeys.STATE,t),this}}t.default=n},474:function(e,t,o){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(o(56));t.default=class{constructor(e){this.response=new r.default(e)}getDecodedToken(){let e=this.getToken().split(".")[1];if(!e)throw new Error("Could not extract the Base 64 url out of the token");let t=e.replace(/-/g,"+").replace(/_/g,"/"),o=decodeURIComponent(atob(t).split("").map((function(e){return"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)})).join("")),s=JSON.parse(o);if("object"!=typeof s)throw new Error("Error: Could not construct a decoded token out of the token value "+this.getToken());return s}getToken(){let e=this.response.getResponseObject();if("string"!=typeof e.token)throw new Error("Could not retrieve token!");return e.token}getRefreshToken(){let e=this.response.getResponseObject();if("string"!=typeof e.refresh_token)throw new Error("Could not retrieve refresh token!");return e.refresh_token}}},675:function(e,t,o){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(o(116)),n=s(o(474)),i=o(530),l=o(500),a=s(o(56));t.default=class{constructor(e){this.pm=e,this.logger=new i.Logger,this.env=new r.default(e,this.logger)}setPm(e){this.pm=e,this.env.setPm(e)}prerequest(e){this.logger.log("Running universal pre-request",i.LogLevel.info,i.LogVerbosity.verbose),this.setPm(e),this.env.validate();const t={},o=this.getEnv().getState().getAll();Object.keys(o).map((e=>t[e]=o[e])),Object.keys(o).map((e=>this.pm.variables.set(e,o[e])));const s=this.getEnv().getCollectionState().getAll();Object.keys(s).map((e=>t[e]=s[e])),Object.keys(s).map((e=>this.pm.variables.set(e,s[e]))),this.logger.log(["Available variables: ",t],i.LogLevel.info,i.LogVerbosity.verbose)}pretests(e){this.setPm(e)}assert(e){if(!this.pm.variables.has(e))throw new Error(`The environment variable ${e} should exist as a local variable, but does not.  It may have been cleared by a prior operation, or not yet set with the appropriate LIST or POST call.`);return this}getEnv(){return this.env}getLogger(){return this.logger}addTokenData(){let e=new n.default(this.pm.response.text());this.logger.log(["Adding token data:",e.getDecodedToken()],i.LogLevel.info,i.LogVerbosity.minimal);const t=this.env.getState();t.set("tokens.current",e.getToken()),t.set("refresh_tokens.current",e.getRefreshToken());const o=e.getDecodedToken().email;t.set("tokens."+o,e.getToken()),t.set("refresh_tokens."+o,e.getRefreshToken());const s=e.getDecodedToken();return Object.keys(s).map((e=>{let r=s[e];if(Array.isArray(r))r.map(((s,r)=>{if(!s)throw"No IRI available, cannot get ID.";let n=(0,l.iri_to_id)(s);t.set(o+"."+e+"."+r,n),t.set("current_user."+e+"."+r,n)}));else if("string"==typeof r){let o=(0,l.iri_to_id)(r);t.set("current_user."+e,o)}else t.set("current_user."+e,r)})),this.logger.log(["Token data added.  Environment: ",this.env.filter()],i.LogLevel.default,i.LogVerbosity.minimal),this}clearEndpointVar(e){this.pm.expect(this.pm.response.code).to.be.oneOf([200,201,204]);const t=this.pm.request.url.path[0],o=this.env.getState();return o.getAll().filter((o=>o===`${t}.${e}`)).map((e=>o.delete(e))),this}clearEndpointVars(){void 0!==this.pm.response&&this.pm.expect(this.pm.response.code).to.be.oneOf([200,201,204]);const e=this.pm.request.url.path[0],t=this.env.getState();return t.getAll().filter((t=>t.startsWith(e))).map((e=>t.delete(e))),this}getResponse(){return new a.default(this.pm.response.text())}getStoredPassword(){throw new Error("Not yet implemented")}setEndpointVar(e){const t=this.getResponse().getFromResponse("@id"),o=(0,l.iri_to_id)(t),s=this.pm.request.url.path[0];return this.env.getState().set(s+".last",o),this}setEndpointVars(e=null){this.pm.expect(this.pm.response.code).to.be.oneOf([200,201]);let t=this.getResponse().getObjects();if(0===t.length)return this.logger.log("No results returned, not setting any endpoint vars",i.LogLevel.default,i.LogVerbosity.very_verbose),this;const o=e??this.pm.request.url.path[0],s=(e,t,o)=>{this.pm.expect(e).to.be.a("string"),this.pm.expect(t).to.not.be.undefined(),this.pm.expect(o).to.be.an("object"),this.pm.expect(o["@id"]).to.be.a("string");let s=o["@id"];if("string"!=typeof s)throw new Error("IRI could not be found for item in list.");const r=this.env.getState();let n=(0,l.iri_to_id)(s);r.set(e+"."+t,n),r.set(e+".iri."+t,s),r.set(e+".objects."+t,o)};return t.map(((e,r)=>{s(o,(r+1).toString(),e),0===r?s(o,"first",e):r===t.length-1&&s(o,"last",e)})),this}setVar(e,t){return this.getEnv().getState().set(e,t),this}setVarFromKey(e,t){return this.env.getState().set(e,this.getResponse().getFromResponse(t)),this}setVarFromCallback(e,t){let o=t(this.getResponse().getResponseObject());if((0,l.is_empty)(o))throw new Error("setVarFromCallback: The supplied callback {fn} did not return a value.");return this.env.getState().set(e,o),this}setRandomString(){return this.env.getState().set("random_string",(0,l.random_string)(15,"aA")),this}}},607:function(e,t,o){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(o(675));t.default=function(e){if("object"!=typeof e)throw new Error("Expected postman object as initial value, got "+typeof e);return new r.default(e)}}},t={};return function o(s){var r=t[s];if(void 0!==r)return r.exports;var n=t[s]={exports:{}};return e[s].call(n.exports,n,n.exports,o),n.exports}(607)})()));